<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Working with policies â€“ How to</title>
    <link rel="stylesheet" type="text/css" href="style/howto.css" />
</head>
<body>
<h1>Implementing SOAPUI tests to unit test policies</h1>
<p>This guide shows how existing SOAPUI test can be used to test policies made for OTK and MAG. The idea is to get a good
    understanding how this works so that more test can be implemented. Certainly also for any policies.</p>
<p>The SOAPUI tests discussed here are built on top of SOAPUI 5.2.1. For more info on SOAPUI please refer to <a href="https://www.soapui.org/" target="_blank">SOAPUI web site</a>.</p>
<p>This how to guide explains the following:</p>
<ol>
    <li><a href="#soapuiFeatures">Used features of SOAPUI</a></li>
    <li><a href="#testingOTK">How to test OTK</a></li>
    <li><a href="#groovyExamples">Groovy examples</a></li>
    <li><a href="#tools">Tools</a></li>
</ol>
<h3 id="soapuiFeatures">Used features of SOAPUI</h3>
<p>For anybody who hasn't used SOAPUI, it is a tool that can be used to test API's. Any API implementing a SOAP or REST interface is preferred. SOAPUI can do functional tests just as load tests.
SOAPUI tests can use hard coded parameters or parameters loaded from a properties file. Tests can be executed via the UI or on the command line.</p>
<p>For the existing OTK and MAG tests the following features were used:</p>
<ol>
    <li><b>Empty projects: </b>No WSDL, WADL or Swagger was used, just an 'Empty Project'. This is more flexible with changes during the API development process</li>
    <li><b>Setup &amp; TearDown: </b>The order of how TestSuites are implemented determines their execution order. Knowing that a SetUp and TearDown test suite was implemented</li>
    <li><b>custom properties: </b>Project, TestSuite and TestCase properties</li>
    <li><b>groovy scripts: </b>Used to generate random values and to assert certain HTTP response headers</li>
    <li><b>property transfers: </b>Used to extract values of a HTTP response and use it as input for a following HTTP request</li>
    <li><b>assertions: </b>Used to verify HTTP Response values. As in java JUnit test, here for API response values</li>
    <li><b>RESTMan requests: </b>Some tests are installing and also removing polices from the target gateway. In order to test encapsulated assertions APIs were implemented that take
    certain input parameters and use an encapsulated assertion. Since these APIs are only meant for testing they are installed and removed during test runs.</li>
</ol>
<h3 id="testingOTK">How to test OTK</h3>
<p>The version of OTK used with these discussed SOAPUI tests is OTK-3.5.01 (SSG-9.2)</p>
<h4>Preparation</h4>
<p>Before we go any further the following pre-requisites apply:</p>
<ol>
    <li>SOAPUI MUST be installed. Use version 5.2.1 to be comparable with tests used here. For any other version ... no clue how that effects testing</li>
    <li>SSG-9.2 MUST be configured and running</li>
    <li>OTK-3.5.01 MUST be configured and running</li>
    <li>RESTman MUST be installed and the RESTman policy must be edited such that the "Require HTTP Basic Credentials" is evaluated first, as shown in this screenshot:
        <img src="images/01RestmanSetup.png" /> </li>
    <li>SOAPUI MUST be able to connect to the gateway</li>
</ol>
<h4>Configuration</h4>
<p>All SOAPUI tests use hardcoded properties and properties configured within a properties file. If OTK was installed without prefix and without
modifying any API path not much has to be done. Do the following:</p>
<ol>
    <li>Make a copy of <b>otk-mag-unittest-local-template.properties</b> to use as your local configuration. For example purposes, this file will be referred to as
    <b>otk-mag-unittest-local-mine.properties</b></li>
    <li><i>username, password</i>: Configure a valid gateway user</li>
    <li><i>restman_credentials_b64</i>: These have to be the base64 encoded credentials to authenticate a gateway administrator that is able to use RESTMan.
    To base64 encode/decode values click <a href="#tools">here</a></li>
    <li><i>hostname</i>: Configure the target gateway's hostname including the port, e.g.: myssg.ca.com:8443</li>
    <li><i>hostname_clientstore</i>: Configure the target gateway's hostname which implement the the API <i>/oauth/clientstore/*</i> (most likely the same as 'hostname')</li>
    <li><i>hostname_sessionstore</i>: Configure the target gateway's hostname which implement the the API <i>/oauth/session</i> (most likely the same as 'hostname')</li>
    <li><i>hostname_tokenstore</i>: Configure the target gateway's hostname which implement the the API <i>/oauth/tokenstore/*</i> (most likely the same as 'hostname')</li>
</ol>
<p>Now one policy in OTK has to be modified. This is to disable certificate based client authentication. This can be skipped
if you have a private key in SOAPUI whose certificate can be authenticated on the gateway. If not, just do the following:</p>
<ol>
    <li>Open the policy manager</li>
    <li>In the services window (lower left corner) search for <b>OTK FIP Client Authentication</b></li>
    <li>Disable the last line which is a <b>At least one ...</b> assertion</li>
</ol>
<h4>Running SOAPUI</h4>
<p>For now the UI will be used. Simply run SOAPUI and do nothing else for the moment. The first step is to open the provided SOAPUI workspace.
You will find test suites for MAG included, this is just because it is simpler to maintain them together.</p>
<ol>
    <li>In SOAPUI select <b><i>File - Switch Workspace</i></b></li>
    <li>Navigate to the directory that contains <b><i>otk-mag-unittest.xml</i></b> and open it</li>
</ol>
<p>The following screen will be shown within SOAPUI:</p>
<img src="images/01_soapui_workspace.png" alt="SOAPUI screen"/>
<p>For this section we will focus on executing all tests of a project. This includes all TestSuites! It is a very
    straight forward process:</p>
<p>Each top-level <b>project</b> (ie, MAG-Unittest, OTK-Unittest, etc) must first be configured with local properties.  When the SOAPUI workspace
    is initially loaded, each of these projects will be closed.  Double-click the project name to open it.  In the bottom left part of the SOAPUI window,
    you will see the properties for the currently selected project.  Click on the <b>Custom Properties tab</b>, then click the "Load Properties" icon, as
    highlighted in the following screenshot:  <img src="images/01_soapUIProperties.png" />
    <br/>
    Navigate to the folder where the properties files are located
    (typically ~/Gateway-SK-OTK/apitesting/soapui/properties) and select <b>otk-mag-unittest.properties</b>. Ensure the "Creates Missing Properties" setting is
    checked and click OK.  Next, do the same thing, but this time select the <b>otk-mag-unittest-local-mine.properties</b> file.
    <br/>
    Repeat the custom properties loading for EACH project.
    <br/>
    <b>Note:</b> After setting all custom properties, try selecting File-->Save All Projects to ensure that all projects can be saved.  If you get an error
    that suggests some file could not be found, right-click on the affected project and select "Save Project" - navigate to the folder where the project
    file is located (typically ~/Gateway-SK-OTK/apitesting/soapui/project) and save in this folder to overwrite the existing file.  By doing this,
    you should be able to save all the projects on SOAPUI exit.  This also ensures the projects are saved with your custom property settings
    so that you don't have to repeat the above setup process again.
</p>
<ol>
    <li>double-click <b>OTK-Unittest</b></li>
    <li>select <b>TestSuites</b> at the top of the opening dialog</li>
    <li>Click the green arrow</li>
</ol>
<p>If everything went well you will see the dialog as below:</p>
<img src="images/01_soapui_testresult_green.png" alt="SOAPUI test result - green"/>
<h4 id="groovyExamples">Groovy examples</h4>
<p>Here are examples on how we used groovy. Keep in mind that I have googled that stuff together so please do not ask me for details. Nevertheless those examples work:</p>
<table>
    <tr>
        <th width="200px">Description</th>
        <th>Groovy script</th>
    </tr>
    <tr>
        <td>Testing a HTTP response header using a script-assertion. 'x-ca-err' is the header we are looking for, '3003113' is the expected value</td>
        <td>
            <code>
                def errorCode = messageExchange.getResponseHeaders()["x-ca-err"][0]<br/>
                assert errorCode == '3003113'
            </code>
        </td>
    </tr>
    <tr>
        <td>Using regex to extract a value of response header and make value available via a variable. 'Grant' is a
            preceding test step. 'Location' is a HTTP header of the 'Grant' response. 'code' is later on used as variable. Use a 'transfer property' assertion to reference it.</td>
        <td>
            <code>
                def location = testRunner.testCase.getTestStepByName("Grant").httpRequest.response.responseHeaders["Location"][0]<br/>
                def m = location =~ /code=([^&]+)/;<br/>
                if (!m) {<br/>
                  throw new RuntimeException("No code returned!");<br/>
                }<br/>
                def code = m.group(1);<br/>
            </code>
        </td>
    </tr>
        <td>Creating a value as nonce. Here we simply use a timestamp. Afterwards we use a 'property transfer' test step and refer to 'CreateNonce.result'</td>
        <td>
            <code>
                new Date().format("yyyy-MM-dd HH:mm:ss.SSS")
            </code>
        </td>
    </tr>
</table>
<h4 id="tools">Tools</h4>
<p>Here a list of tools that may be useful when building or testing  policies:</p>
<table>
    <tr>
        <th width="200px">Description</th>
        <th>Tool</th>
    </tr>
    <tr>
        <td>A tool to base64 encode and decode values</td>
        <td><a href="base64.html" target="_blank">base64 tool</a></td>
    </tr>
</table>
<br/>
<input onclick='window.history.back()' value='Back' type='button' />
</body>
</html>